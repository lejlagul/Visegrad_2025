<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Interactive Host–Microbe PPI Viewer</title>
  <!-- NGL for 3‑D rendering -->
  <script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>
  <!-- dat.GUI for a tiny control panel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat.gui/0.7.9/dat.gui.min.js"></script>
  <style>
    html,body,#viewport{width:100%;height:100%;margin:0}
    #viewport{position:absolute;top:0;left:0}
    #help{position:absolute;top:8px;left:8px;background:rgba(255,255,255,.85);padding:4px 8px;border-radius:4px;font-size:14px;z-index:10}
    #info{position:absolute;bottom:8px;left:8px;background:rgba(255,255,255,.85);padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;z-index:10;min-width:200px}
    .dg{z-index:11}
  </style>
</head>
<body>
<div id="viewport"></div>
<div id="help">Drag to rotate · Scroll/pinch to zoom · Click residue for details · Double‑click for full‑screen</div>
<div id="info">Residue info will appear here</div>
<script>
  /* ---------------------------------------------------------------------
     1.  DATA SOURCE – *always* try the complex you sent
         – If a global const pdbBase64 is defined we use it (allows manual
           inlining later).
         – Otherwise we read the sibling file af_model.html, extract the
           Base‑64 string that is already there and decode it.
     ------------------------------------------------------------------*/
  async function getPdbBlob(){
    if(typeof pdbBase64!=="undefined"){ // inline override
      return new Blob([atob(pdbBase64)],{type:"text/plain"});
    }
    try{
      const res=await fetch("af_model.html");
      if(res.ok){
        const html=await res.text();
        const m=html.match(/const\s+pdbBase64\s*=\s*"([A-Za-z0-9+/=]+)"/);
        if(m){
          return new Blob([atob(m[1])],{type:"text/plain"});
        }
      }
    }catch(_){}
    alert("No embedded PDB found. Please keep af_model.html in the same folder or define const pdbBase64.");
    throw new Error("No structure");
  }

  /* ---------------------------------------------------------------------
     2.  INITIALISE NGL STAGE
     ------------------------------------------------------------------*/
  const stage=new NGL.Stage("viewport",{backgroundColor:"white"});
  stage.handleScroll=false;
  stage.tooltips=false;

  /* ---------------------------------------------------------------------
     3.  REPRESENTATIONS & GUI LAYERS (chains, domains, motifs)
     ------------------------------------------------------------------*/
  const GUI=new dat.GUI({name:"Controls"});
  const layers={};

  function addChainToggles(comp){
    const folder=GUI.addFolder("Chains");
    comp.structure.eachChain(chain=>{
      const sel=`:${chain.chainname}`;
      const rep=comp.addRepresentation("cartoon",{sele:sel,colorScheme:"chainid"});
      layers[`chain_${chain.chainname}`]=rep;
      const ctrl=folder.add({show:true},"show").name(`Chain ${chain.chainname}`);
      ctrl.onChange(v=>rep.setVisibility(v));
    });
    folder.open();
  }

  // ← customise these selectors/colours to your real domain‑motif pairs
  const exampleDomains=[{name:"Host Domain",sele:"resi 50-120 and :A",colour:"orange"}];
  const exampleMotifs=[{name:"Microbe Motif",sele:"resi 310-315 and :B",colour:"magenta"}];

  function addFeature(folderName,arr,type){
    if(!arr.length) return;
    const folder=GUI.addFolder(folderName);
    arr.forEach(o=>{
      const rep=stage.compList[0].addRepresentation(type,{sele:o.sele,color:o.colour,opacity:0.8});
      layers[o.name]=rep;
      const ctrl=folder.add({show:true},"show").name(o.name);
      ctrl.onChange(v=>rep.setVisibility(v));
    });
  }

  /* ---------------------------------------------------------------------
     4.  RESIDUE CLICK PICKING
     ------------------------------------------------------------------*/
  stage.signals.clicked.add(px=>{
    const info=document.getElementById("info");
    if(px&&px.atom){
      info.textContent=`Chain ${px.atom.chainname} · ${px.atom.resname} ${px.atom.resno}`;
    }
  });

  /* ---------------------------------------------------------------------
     5.  FULL‑SCREEN TOGGLE
     ------------------------------------------------------------------*/
  document.getElementById("viewport").addEventListener("dblclick",()=>stage.toggleFullscreen());

  /* ---------------------------------------------------------------------
     6.  LOAD & GO
     ------------------------------------------------------------------*/
  (async()=>{
    const blob=await getPdbBlob();
    const url=URL.createObjectURL(blob);
    stage.loadFile(url,{ext:"pdb",defaultRepresentation:false}).then(comp=>{
      comp.autoView();
      addChainToggles(comp);
      addFeature("Domains",exampleDomains,"surface");
      addFeature("Motifs",exampleMotifs,"ball+stick");
    });
  })();
</script>
</body>
</html>
