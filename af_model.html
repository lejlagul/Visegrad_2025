<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Interactive Host–Microbe PPI Viewer</title>
  <script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat.gui/0.7.9/dat.gui.min.js"></script>
  <style>
    html,body,#viewport{width:100%;height:100%;margin:0}
    #viewport{position:absolute;top:0;left:0}
    #help{position:absolute;top:8px;left:8px;background:rgba(255,255,255,.85);padding:4px 8px;border-radius:4px;font-size:14px;z-index:10}
    #info{position:absolute;bottom:8px;left:8px;background:rgba(255,255,255,.85);padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;z-index:10;min-width:220px}
    .dg{z-index:11}
  </style>
</head>
<body>
<div id="viewport"></div>
<div id="help">Drag to rotate · Scroll/pinch to zoom · Click residue for details · Double‑click for full‑screen</div>
<div id="info">Residue info will appear here</div>
<script>
  /* ------------------------------------------------------------------
     1.  DATA SOURCE: prefer inline const pdbBase64, else use af_model.html
     ------------------------------------------------------------------*/
  async function getPdbBlob(){
    if(typeof pdbBase64!=="undefined"){
      return new Blob([atob(pdbBase64)],{type:"text/plain"});
    }
    const res=await fetch("af_model.html");
    if(res.ok){
      const html=await res.text();
      const m=html.match(/const\s+pdbBase64\s*=\s*"([A-Za-z0-9+/=]+)"/);
      if(m) return new Blob([atob(m[1])],{type:"text/plain"});
    }
    alert("No PDB model found – add const pdbBase64 or keep af_model.html next to this viewer.");
    throw new Error("No structure");
  }

  /* ------------------------------------------------------------------
     2.  INIT NGL STAGE
     ------------------------------------------------------------------*/
  const stage=new NGL.Stage("viewport",{backgroundColor:"white"});
  stage.handleScroll=false;
  stage.tooltips=false;

  const GUI=new dat.GUI({name:"Layers"});
  const layers={};

  /* ------------------------------------------------------------------
     3.  REPRESENTATIONS: Host vs Microbe + Domains & Motifs
     ------------------------------------------------------------------*/
  const HOST_COLOR="#1565C0";   // blue
  const MICROBE_COLOR="#9E9E9E"; // grey

  function classifyChains(structure){
    const lengths={};
    structure.eachResidue(r=>{
      lengths[r.chainname]=(lengths[r.chainname]||0)+1;
    });
    const chainNames=Object.keys(lengths);
    if(chainNames.length<2) return {host:chainNames[0]||"A",micro:chainNames[0]||"A"};
    chainNames.sort((a,b)=>lengths[a]-lengths[b]); // ascending
    return {host:chainNames[0],micro:chainNames[chainNames.length-1]};
  }

  // customise with real selections
  const domainDefs=[{name:"Host Domain",sele:"resi 50-120 and :A",colour:"orange"}];
  const motifDefs=[{name:"Microbe Motif",sele:"resi 310-315 and :B",colour:"magenta"}];

  function addFeature(folderName,arr,type){
    if(!arr.length) return;
    const folder=GUI.addFolder(folderName);
    arr.forEach(obj=>{
      const rep=stage.compList[0].addRepresentation(type,{sele:obj.sele,color:obj.colour,opacity:0.9});
      layers[obj.name]=rep;
      const ctrl=folder.add({show:true},"show").name(obj.name);
      ctrl.onChange(v=>rep.setVisibility(v));
    });
  }

  /* ------------------------------------------------------------------
     4.  Residue click picking
     ------------------------------------------------------------------*/
  stage.signals.clicked.add(px=>{
    const div=document.getElementById("info");
    if(px&&px.atom){
      div.textContent=`Chain ${px.atom.chainname} · ${px.atom.resname} ${px.atom.resno}`;
    }
  });

  /* ------------------------------------------------------------------
     5.  Full‑screen toggle
     ------------------------------------------------------------------*/
  document.getElementById("viewport").addEventListener("dblclick",()=>stage.toggleFullscreen());

  /* ------------------------------------------------------------------
     6.  Load & go
     ------------------------------------------------------------------*/
  (async()=>{
    const pdbBlob=await getPdbBlob();
    const url=URL.createObjectURL(pdbBlob);
    stage.loadFile(url,{ext:"pdb",defaultRepresentation:false}).then(comp=>{
      const {host,micro}=classifyChains(comp.structure);

      // Main cartoons
      const hostRep=comp.addRepresentation("cartoon",{sele:`:${host}`,color:HOST_COLOR});
      const microRep=comp.addRepresentation("cartoon",{sele:`:${micro}`,color:MICROBE_COLOR});
      layers["Host (blue)"]=hostRep;
      layers["Microbe (grey)"]=microRep;

      // GUI folder for the two components
      const mainFolder=GUI.addFolder("Complex");
      mainFolder.add({show:true},"show").name("Host (blue)").onChange(v=>hostRep.setVisibility(v));
      mainFolder.add({show:true},"show").name("Microbe (grey)").onChange(v=>microRep.setVisibility(v));
      mainFolder.open();

      // Domains & motifs overlays
      addFeature("Domains",domainDefs,"surface");
      addFeature("Motifs",motifDefs,"ball+stick");

      comp.autoView();
    });
  })();
</script>
</body>
</html>
