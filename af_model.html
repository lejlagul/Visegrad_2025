<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Host–Microbe Protein Viewer</title>

<!-- NGL for 3‑D rendering -->
<script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>

<!-- dat.GUI for a tiny control panel -->
<script src="https://cdn.jsdelivr.net/npm/dat.gui"></script>

<!-- FileSaver lets us download PNG snapshots -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
  html,body,#viewport{width:100%;height:100%;margin:0;touch-action:none;}
  #help{
    position:absolute;
    top:8px;left:8px;
    background:rgba(255,255,255,0.85);
    padding:6px 10px;
    border-radius:6px;
    font:14px/1.4 sans-serif;
    z-index:10;
    max-width:240px;
  }
  @media (max-width:480px){ #help{font-size:12px;} }
</style>
</head>
<body>
<div id="viewport"></div>
<div id="help">
  Drag/Swipe to rotate · Pinch/Scroll to zoom · Tap two atoms to measure distance · Press <kbd>S</kbd> to save PNG
</div>

<script>
/* ──────────────────────────────────────────
   USER SETTINGS
   ─────────────────────────────────────── */
const pdbPath       = "af_model.pdb"; // ensure this file sits next to index.html
const contactCutoff = 4;              // Å for interface contacts

/* ──────────────────────────────────────────
   1.  Create the NGL Stage
   ─────────────────────────────────────── */
const stage = new NGL.Stage("viewport",{backgroundColor:"white"});
let comp, interfaceRepr;

/* Disable the built‑in dbl‑click‑to‑fullscreen so phones don’t jump */
stage.viewer.container.addEventListener("dblclick",e=>e.preventDefault(),{capture:true});

/* Load structure and build representations */
stage.loadFile(pdbPath,{defaultRepresentation:false}).then(o=>{
  comp = o;
  const {hostSele,bactSele} = splitChainsByLength(o.structure);
  addBaseRepresentations(hostSele,bactSele);
  stage.autoView();
});

/* Decide which chains are “long” (microbial) vs “short” (host) */
function splitChainsByLength(struct){
  const chainLengths = {};
  struct.eachChain(c=>{
    chainLengths[c.chainname] = c.residueStore.count;
  });

  const maxLen = Math.max(...Object.values(chainLengths));
  const microbeChains = Object.entries(chainLengths)
                       .filter(([_,len])=>len===maxLen)
                       .map(([id])=>id);
  const hostChains = Object.entries(chainLengths)
                       .filter(([_,len])=>len!==maxLen)
                       .map(([id])=>id);

  const makeSele = arr => arr.map(c=>":" + c).join(" OR ");
  return {
    hostSele : makeSele(hostChains),
    bactSele : makeSele(microbeChains)
  };
}

/* Build the starting cartoon representations */
function addBaseRepresentations(hostSele,bactSele){
  comp.addRepresentation("cartoon",{sele:bactSele,color:"grey"});
  comp.addRepresentation("cartoon",{sele:hostSele,color:"royalblue"});
}

/* ──────────────────────────────────────────
   2.  dat.GUI panel
   ─────────────────────────────────────── */
const gui = new dat.GUI({width:260});
const guiState = { "Interface Contacts": false };
gui.add(guiState,"Interface Contacts").onChange(toggleInterface);

function toggleInterface(show){
  if(show){
    if(interfaceRepr) return;
    const {hostSele,bactSele} = splitChainsByLength(comp.structure);
    const hostInt = `(${hostSele}) and within ${contactCutoff} of (${bactSele})`;
    const bactInt = `(${bactSele}) and within ${contactCutoff} of (${hostSele})`;
    interfaceRepr = [
      comp.addRepresentation("ball+stick",{sele:hostInt,color:"hotpink"}),
      comp.addRepresentation("ball+stick",{sele:bactInt,color:"yellow"})
    ];
  }else if(interfaceRepr){
    interfaceRepr.forEach(r=>r.dispose());
    interfaceRepr = undefined;
  }
}

/* ──────────────────────────────────────────
   3.  Two‑atom distance measurement
   ─────────────────────────────────────── */
let picks = [];
stage.signals.clicked.add(p=>{
  if(!p || !p.atom) return;
  picks.push(p.atom);
  if(picks.length===2){
    const d = picks[0].distanceTo(picks[1]).toFixed(2);
    alert(`Distance: ${d} Å`);
    picks = [];
  }
});

/* ──────────────────────────────────────────
   4.  PNG snapshot on “S”
   ─────────────────────────────────────── */
window.addEventListener("keydown",e=>{
  if(e.key.toUpperCase()==="S"){
    stage.makeImage({trim:true,factor:2})
         .then(blob=>saveAs(blob,"host_microbe_snapshot.png"));
  }
});
</script>
</body>
</html>
