<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Host–Microbe Protein Viewer</title>
<!-- NGL for 3‑D rendering -->
<script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>
<!-- dat.GUI for a tiny control panel -->
<script src="https://cdn.jsdelivr.net/npm/dat.gui"></script>
<!-- FileSaver lets us download PNG snapshots -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  html,body,#viewport{width:100%;height:100%;margin:0;}
  #help{
    position:absolute;
    top:8px;left:8px;
    background:rgba(255,255,255,0.85);
    padding:4px 8px;
    border-radius:4px;
    font:14px/1.4 sans-serif;
    z-index:10;
  }
</style>
</head>
<body>
<div id="viewport"></div>
<div id="help">
  Drag to rotate · Scroll to zoom · Click two atoms to measure distance · Press <kbd>S</kbd> to save PNG
</div>

<script>
// ──────────────────────────────────────────────────────
// USER‑EDITABLE SETTINGS
// ──────────────────────────────────────────────────────
const pdbPath      = "af_model.pdb"; // make sure the PDB file is in the same folder
const hostSele     = "A";  // host chains (edit as needed)
const microbeSele  = "B";  // microbe chains (edit as needed)
const contactCutoff = 4;    // Å distance used for interface contacts

// ──────────────────────────────────────────────────────
// 1.  Create the NGL Stage
// ──────────────────────────────────────────────────────
const stage = new NGL.Stage("viewport", { backgroundColor:"white" });
let comp, surfaceRepr, interfaceRepr;

// Prevent default double‑click fullscreen (so we can decide later)
stage.viewer.container.addEventListener("dblclick", e => e.preventDefault(), { capture:true });

// Load structure, then add starter representations
stage.loadFile(pdbPath, { defaultRepresentation:false }).then(o => {
    comp = o;
    addBaseRepresentations();
    stage.autoView();
});

function addBaseRepresentations(){
    comp.addRepresentation("cartoon", { sele: hostSele,    color:"steelblue" });
    comp.addRepresentation("cartoon", { sele: microbeSele, color:"salmon"   });
}

// ──────────────────────────────────────────────────────
// 2.  dat.GUI panel
// ──────────────────────────────────────────────────────
const gui      = new dat.GUI();
const guiState = {
  "Electrostatic Surface": false,
  "Interface Contacts":    false
};

gui.add(guiState, "Electrostatic Surface").onChange(toggleSurface);
gui.add(guiState, "Interface Contacts"   ).onChange(toggleInterface);

function toggleSurface(show){
  if(show){
     surfaceRepr = comp.addRepresentation("surface", {
       sele: `${hostSele} or ${microbeSele}`,
       colorScheme:"electrostatic",
       opacity:0.5
     });
  } else if(surfaceRepr){
     surfaceRepr.dispose();
     surfaceRepr = undefined;
  }
}

function toggleInterface(show){
  if(show){
     const hostInt  = `(${hostSele}) and within ${contactCutoff} of (${microbeSele})`;
     const microInt = `(${microbeSele}) and within ${contactCutoff} of (${hostSele})`;
     interfaceRepr = [
       comp.addRepresentation("ball+stick", { sele:hostInt,  color:"hotpink" }),
       comp.addRepresentation("ball+stick", { sele:microInt, color:"yellow"  })
     ];
  } else if(interfaceRepr){
     interfaceRepr.forEach(r => r.dispose());
     interfaceRepr = undefined;
  }
}

// ──────────────────────────────────────────────────────
// 3.  Two‑click distance measurement
// ──────────────────────────────────────────────────────
let picks = [];
stage.signals.clicked.add(p => {
  if(!p || !p.atom) return;
  picks.push(p.atom);
  if(picks.length === 2){
     const d = picks[0].distanceTo(picks[1]).toFixed(2);
     alert(`Distance: ${d} Å`);
     picks = [];
  }
});

// ──────────────────────────────────────────────────────
// 4.  PNG snapshot on “S” key
// ──────────────────────────────────────────────────────
window.addEventListener("keydown", e => {
  if(e.key.toUpperCase() === "S"){
    stage.makeImage({ trim:true, factor:2 })
         .then(blob => saveAs(blob, "host_microbe_snapshot.png"));
  }
});
</script>
</body>
</html>
