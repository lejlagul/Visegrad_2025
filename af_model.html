<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Host‑Microbe Complex Viewer</title>

<!-- libs -->
<script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dat.gui"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
 html,body,#viewport{width:100%;height:100%;margin:0;padding:0;overflow:hidden;}
 #help{
    position:absolute;top:8px;left:8px;z-index:10;
    background:rgba(255,255,255,.85);padding:4px 8px;border-radius:4px;
    font:14px/1.4 sans-serif;
 }
 @media (max-width:680px){#help{font-size:12px}}
</style>
</head>
<body>

<div id="viewport"></div>
<div id="help">
   <b>Legend:</b> host = blue · microbe = grey<br>
   Drag / pinch to rotate/zoom · tap 2 atoms → distance · press <kbd>S</kbd> → PNG
</div>

<script>
/* ─────────────────────────────────────────
   1.  Create the stage and load the model
   ───────────────────────────────────────── */
const stage = new NGL.Stage("viewport",{backgroundColor:"white"});
let comp, interfaceRepr;

// stop the built‑in dbl‑click→fullscreen so mobile dbl‑tap zoom still works
stage.viewer.container.addEventListener("dblclick",e=>e.preventDefault(),{capture:true});

// Load PDB, then colour chains by length
stage.loadFile("af_model.pdb",{defaultRepresentation:false}).then(o=>{
   comp=o;
   const chainLengths = {};
   o.structure.eachResidue(r=>{
      const id=r.chainname||r.chain;   // works for mmCIF & PDB
      chainLengths[id]= (chainLengths[id]||0)+1;
   });
   // sort chains by residue count (descending)
   const chains = Object.keys(chainLengths).sort((a,b)=>chainLengths[b]-chainLengths[a]);
   const microbeSele = chains[0];           // longest chain
   const hostSele    = chains[chains.length-1]; // shortest (works for 2‑chain complex)

   // base cartoon reps
   comp.addRepresentation("cartoon",{sele:hostSele,   color:"steelblue"});
   comp.addRepresentation("cartoon",{sele:microbeSele,color:"lightgrey"});

   // store for later use by the GUI toggle
   comp.parameters._hostSele    = hostSele;
   comp.parameters._microbeSele = microbeSele;

   stage.autoView();
   buildGUI();
});

/* ─────────────────────────────────────────
   2.  dat.GUI – interface contacts toggle
   ───────────────────────────────────────── */
function buildGUI(){
   const guiState={Interface_Contacts:false};
   const gui=new dat.GUI({width:200});
   gui.add(guiState,"Interface_Contacts").onChange(show=>{
      toggleInterface(show,
                      comp.parameters._hostSele,
                      comp.parameters._microbeSele);
   });
}

function toggleInterface(show,hostSele,microbeSele,cutoff=4){
   if(show){
      const hostInt  =`(${hostSele}) and within ${cutoff} of (${microbeSele})`;
      const microInt =`(${microbeSele}) and within ${cutoff} of (${hostSele})`;
      interfaceRepr=[
        comp.addRepresentation("ball+stick",{sele:hostInt, color:"hotpink"}),
        comp.addRepresentation("ball+stick",{sele:microInt,color:"yellow"})
      ];
   }else if(interfaceRepr){
      interfaceRepr.forEach(r=>r.dispose());
      interfaceRepr=undefined;
   }
}

/* ─────────────────────────────────────────
   3.  Two‑click distance measurement
   ───────────────────────────────────────── */
let picks=[];
stage.signals.clicked.add(p=>{
   if(!p||!p.atom)return;
   picks.push(p.atom);
   if(picks.length===2){
      const d=picks[0].distanceTo(picks[1]).toFixed(2);
      alert(`Distance: ${d} Å`);
      picks=[];
   }
});

/* ─────────────────────────────────────────
   4.  “S” key → hi‑res PNG snapshot
   ───────────────────────────────────────── */
window.addEventListener("keydown",e=>{
   if(e.key.toUpperCase()==="S"){
      stage.makeImage({trim:true,factor:2})
           .then(blob=>saveAs(blob,"host_microbe_snapshot.png"));
   }
});
</script>
</body>
</html>
